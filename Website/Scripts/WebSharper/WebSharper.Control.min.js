(function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F;a=window;b=a.WebSharper=a.WebSharper||{};c=b.Control=b.Control||{};d=c.Observer=c.Observer||{};e=d.Message=d.Message||{};f=c.HotStream=c.HotStream||{};g=f.HotStream=f.HotStream||{};h=c.Observable=c.Observable||{};i=a.Microsoft=a.Microsoft||{};j=i.FSharp=i.FSharp||{};k=j.Control=j.Control||{};l=k.ObservableModule=k.ObservableModule||{};m=c.Event=c.Event||{};n=m.Event=m.Event||{};o=c.DelegateEvent=c.DelegateEvent||{};p=o.DelegateEvent=o.DelegateEvent||{};q=c.FSharpEvent=c.FSharpEvent||{};r=c.FSharpDelegateEvent=c.FSharpDelegateEvent||{};s=k.EventModule=k.EventModule||{};t=c.MailboxProcessor=c.MailboxProcessor||{};u=a.IntelliFactory;v=u&&u.Runtime;w=b&&b.Util;x=b&&b.List;y=b&&b.Seq;z=b&&b.Unchecked;A=b&&b.Arrays;B=b&&b.Concurrency;C=b&&b.TimeoutException;D=b&&b.Operators;E=b&&b.Collections;F=E&&E.LinkedList;e.Completed={$:2};d.New=function(G,H,I){return{OnNext:G,OnError:H,OnCompleted:function(){return I();}};};d.Of=function(G){return{OnNext:G,OnError:function(H){throw H;},OnCompleted:function(){return null;}};};g=f.HotStream=v.Class({Trigger:function(G){this.Latest[0]={$:1,$0:G};this.Event.event.Trigger(G);},Subscribe:function(G){this.Latest[0]!=null?G.OnNext(this.Latest[0].$0):void 0;return this.Event.event.Subscribe(w.observer(function(H){G.OnNext(H);}));}},null,g);g.New$1=function(){return g.New([null],new q.New());};g.New=function(G,H){return new g({Latest:G,Event:H});};h.Sequence=function(G){function H(I){return I.$==1?h.CombineLatest(I.$0,H(I.$1),function(J,K){return new x.T({$:1,$0:J,$1:K});}):h.Return(x.T.Empty);}return H(x.ofSeq(G));};h.Aggregate=function(G,H,I){return{Subscribe:function(J){var K;K=[H];return G.Subscribe(d.New(function(L){h.Protect(function(){return I(K[0],L);},function(M){K[0]=M;J.OnNext(M);},function(M){J.OnError(M);});},function(L){J.OnError(L);},function(){J.OnCompleted();}));}};};h.SelectMany=function(G){return{Subscribe:function(H){var I,J;function K(){I[0]();J.Dispose();}I=[a.ignore];J=G.Subscribe(w.observer(function(L){var M;M=L.Subscribe(w.observer(function(N){H.OnNext(N);}));I[0]=function(){I[0]();M.Dispose();};}));return{Dispose:function(){return K();}};}};};h.Switch=function(G){return{Subscribe:function(H){var I,J;I=[0];J=[null];return G.Subscribe(w.observer(function(K){var L;I[0]++;J[0]!=null?J[0].$0.Dispose():void 0;L=I[0];J[0]={$:1,$0:K.Subscribe(w.observer(function(M){if(L===I[0])H.OnNext(M);}))};}));}};};h.CombineLatest=function(G,H,I){return{Subscribe:function(J){var K,L,M,N;function O(){var Q,R,S,T;Q=K[0];R=L[0];Q!=null&&Q.$==1?R!=null&&R.$==1?(S=Q.$0,T=R.$0,h.Protect(function(){return I(S,T);},function(U){J.OnNext(U);},function(U){J.OnError(U);})):void 0:void 0;}function P(){M.Dispose();N.Dispose();}K=[null];L=[null];M=G.Subscribe(d.New(function(Q){K[0]={$:1,$0:Q};O();},a.ignore,a.ignore));N=H.Subscribe(d.New(function(Q){L[0]={$:1,$0:Q};O();},a.ignore,a.ignore));return{Dispose:function(){return P();}};}};};h.Range=function(G,H){return{Subscribe:function(I){var K,L;function J(){}for(K=G,L=G+H;K<=L;K++)I.OnNext(K);return{Dispose:function(){return J();}};}};};h.Concat=function(G,H){return{Subscribe:function(I){var J,K;function L(){J[0]!=null?J[0].$0.Dispose():void 0;K.Dispose();}J=[null];K=G.Subscribe(d.New(function(M){I.OnNext(M);},a.ignore,function(){J[0]={$:1,$0:H.Subscribe(I)};}));return{Dispose:function(){return L();}};}};};h.Merge=function(G,H){return{Subscribe:function(I){var J,K,L,M;function N(){L.Dispose();M.Dispose();}J=[false];K=[false];L=G.Subscribe(d.New(function(O){I.OnNext(O);},a.ignore,function(){J[0]=true;J[0]&&K[0]?I.OnCompleted():void 0;}));M=H.Subscribe(d.New(function(O){I.OnNext(O);},a.ignore,function(){K[0]=true;J[0]&&K[0]?I.OnCompleted():void 0;}));return{Dispose:function(){return N();}};}};};h.Drop=function(G,H){return{Subscribe:function(I){var J;J=[0];return H.Subscribe(d.New(function(K){J[0]++;J[0]>G?I.OnNext(K):void 0;},function(K){I.OnError(K);},function(){I.OnCompleted();}));}};};h.Choose=function(G,H){return{Subscribe:function(I){return H.Subscribe(d.New(function(J){function K(L){I.OnNext(L);}h.Protect(function(){return G(J);},function(L){if(L==null);else K(L.$0);},function(L){I.OnError(L);});},function(J){I.OnError(J);},function(){I.OnCompleted();}));}};};h.Filter=function(G,H){return{Subscribe:function(I){return H.Subscribe(d.New(function(J){function K(L){I.OnNext(L);}h.Protect(function(){return G(J)?{$:1,$0:J}:null;},function(L){if(L==null);else K(L.$0);},function(L){I.OnError(L);});},function(J){I.OnError(J);},function(){I.OnCompleted();}));}};};h.Map=function(G,H){return{Subscribe:function(I){return H.Subscribe(d.New(function(J){h.Protect(function(){return G(J);},function(K){I.OnNext(K);},function(K){I.OnError(K);});},function(J){I.OnError(J);},function(){I.OnCompleted();}));}};};h.Protect=function(G,H,I){var J;try{J={$:0,$0:G()};}catch(K){J={$:1,$0:K};}return J.$==1?I(J.$0):H(J.$0);};h.Never=function(){return{Subscribe:function(){function G(){}return{Dispose:function(){return G();}};}};};h.Return=function(G){return{Subscribe:function(H){function I(){}H.OnNext(G);H.OnCompleted();return{Dispose:function(){return I();}};}};};h.Of=function(G){return{Subscribe:function(H){var I;I=G(function(J){H.OnNext(J);});return{Dispose:function(){return I();}};}};};l.Split=function(G,H){return[h.Choose(function(I){var J;J=G(I);return J.$==0?{$:1,$0:J.$0}:null;},H),h.Choose(function(I){var J;J=G(I);return J.$==1?{$:1,$0:J.$0}:null;},H)];};l.Scan=function(G,H,I){return{Subscribe:function(J){var K;K=[H];return I.Subscribe(d.New(function(L){h.Protect(function(){return G(K[0],L);},function(M){K[0]=M;J.OnNext(M);},function(M){J.OnError(M);});},function(L){J.OnError(L);},function(){J.OnCompleted();}));}};};l.Partition=function(G,H){function I(J){return!J;}return[h.Filter(G,H),h.Filter(function(J){return I(G(J));},H)];};l.Pairwise=function(G){return{Subscribe:function(H){var I;I=[null];return G.Subscribe(d.New(function(J){var K;K=I[0];K!=null&&K.$==1?H.OnNext([K.$0,J]):void 0;I[0]={$:1,$0:J};},function(J){H.OnError(J);},function(){H.OnCompleted();}));}};};n=m.Event=v.Class({Subscribe$1:function(G){var H;function I(K,L){return G.OnNext(L);}function J(){H.RemoveHandler$1(I);}H=this;this.AddHandler$1(I);return{Dispose:function(){return J();}};},RemoveHandler$1:function(G){var H,I;H=y.tryFindIndex(function(J){return z.Equals(G,J);},this.Handlers);H==null?void 0:(I=this.Handlers,I.splice.apply(I,[H.$0,1]));},AddHandler$1:function(G){this.Handlers.push(G);},Trigger:function(G){var H,I,J;H=this.Handlers.slice();for(I=0,J=H.length-1;I<=J;I++)(A.get(H,I))(null,G);},RemoveHandler:function(G){this.RemoveHandler$1(G);},AddHandler:function(G){this.AddHandler$1(G);},Subscribe:function(G){return this.Subscribe$1(G);},Dispose:a.ignore},null,n);n.New=function(G){return new n({Handlers:G});};p=o.DelegateEvent=v.Class({RemoveHandler$1:function(G){var H,I;H=y.tryFindIndex(function(J){return z.Equals(G,J);},this.Handlers);H==null?void 0:(I=this.Handlers,I.splice.apply(I,[H.$0,1]));},AddHandler$1:function(G){this.Handlers.push(G);},Trigger:function(G){var H,I,J;H=this.Handlers.slice();for(I=0,J=H.length-1;I<=J;I++)A.get(H,I).apply(null,G);},RemoveHandler:function(G){this.RemoveHandler$1(G);},AddHandler:function(G){this.AddHandler$1(G);},Dispose:a.ignore},null,p);p.New=function(G){return new p({Handlers:G});};q=c.FSharpEvent=v.Class({},b.Obj,q);q.New=v.Ctor(function(){this.event=n.New([]);},q);r=c.FSharpDelegateEvent=v.Class({},b.Obj,r);r.New=v.Ctor(function(){this.event=p.New([]);},r);s.Split=function(G,H){return[s.Choose(function(I){var J;J=G(I);return J.$==0?{$:1,$0:J.$0}:null;},H),s.Choose(function(I){var J;J=G(I);return J.$==1?{$:1,$0:J.$0}:null;},H)];};s.Scan=function(G,H,I){var J;J=[H];return s.Map(function(K){J[0]=G(J[0],K);return J[0];},I);};s.Partition=function(G,H){function I(J){return!J;}return[s.Filter(G,H),s.Filter(function(J){return I(G(J));},H)];};s.Pairwise=function(G){var H,I;H=[null];I=n.New([]);G.Subscribe(w.observer(function(J){var K;K=H[0];K!=null&&K.$==1?(H[0]={$:1,$0:J},I.Trigger([K.$0,J])):H[0]={$:1,$0:J};}));return I;};s.Merge=function(G,H){var I;I=n.New([]);G.Subscribe(w.observer(function(J){I.Trigger(J);}));H.Subscribe(w.observer(function(J){I.Trigger(J);}));return I;};s.Map=function(G,H){var I;I=n.New([]);H.Subscribe(w.observer(function(J){I.Trigger(G(J));}));return I;};s.Filter=function(G,H){var I;I=n.New([]);H.Subscribe(w.observer(function(J){if(G(J))I.Trigger(J);}));return I;};s.Choose=function(G,H){var I;I=new q.New();H.Subscribe(w.observer(function(J){var K;K=G(J);K==null?void 0:I.event.Trigger(K.$0);}));return I.event;};t=c.MailboxProcessor=v.Class({dequeue:function(){var G;G=this.mailbox.n.v;this.mailbox.RemoveFirst();return G;},resume:function(){var G;G=this.savedCont;G!=null&&G.$==1?(this.savedCont=null,this.startAsync(G.$0)):void 0;},startAsync:function(G){B.Start(G,this.token);},Scan:function(G,H){var I,J;I=this;J=null;return B.Delay(function(){return B.Bind(I.TryScan(G,H),function(K){var L,M;if(K!=null&&K.$==1)M=K.$0;else throw new C.New();return B.Return(M);});});},TryScan:function(G,H){var I,J,K,L;I=this;J=(K=this.get_DefaultTimeout(),H==null?K:H.$0);L=null;return B.Delay(function(){var M,N,O,Q;function P(R){var T,U;function S(){var W;I.savedCont={$:1,$0:(W=null,B.Delay(function(){var X;X=G(I.mailbox.n.v);return X!=null&&X.$==1?(I.mailbox.RemoveFirst(),B.Bind(X.$0,function(Y){R({$:1,$0:Y});return B.Zero();})):(S(),B.Zero());}))};}function V(){var W;I.savedCont={$:1,$0:(W=null,B.Delay(function(){var X;X=G(I.mailbox.n.v);return X!=null&&X.$==1?(I.mailbox.RemoveFirst(),B.Bind(X.$0,function(Y){return T[0]?(T[0]=false,a.clearTimeout(U),R({$:1,$0:Y}),B.Zero()):B.Zero();})):(V(),B.Zero());}))};}if(J<0){S();}else{T=[true];U=a.setTimeout(function(){if(T[0]){T[0]=false;I.savedCont=null;R(null);}},J);V();}}N=I.mailbox.n;O=null;while(!z.Equals(N,null)){Q=G(N.v);Q==null?N=N.n:(I.mailbox.Remove$1(N),N=null,O=Q);}M=O;return M!=null&&M.$==1?B.Bind(M.$0,function(R){return B.Return({$:1,$0:R});}):B.FromContinuations(function(R,S,T){return P.apply(null,[R,S,T]);});});},PostAndAsyncReply:function(G,H){var I,J;I=this;J=null;return B.Delay(function(){return B.Bind(I.PostAndTryAsyncReply(G,H),function(K){var L,M;if(K!=null&&K.$==1)M=K.$0;else throw new C.New();return B.Return(M);});});},PostAndTryAsyncReply:function(G,H){var I,J,K;function L(M){var O;function N(P){return{$:1,$0:P};}if(J<0){I.mailbox.AddLast(G(function(P){return M(N(P));}));I.resume();}else{O=[true];I.mailbox.AddLast(G(function(P){if(O[0]){O[0]=false;M({$:1,$0:P});}}));I.resume();a.setTimeout(function(){if(O[0]){O[0]=false;M(null);}},J);}}I=this;J=(K=this.get_DefaultTimeout(),H==null?K:H.$0);return B.FromContinuations(function(M,N,O){return L.apply(null,[M,N,O]);});},get_CurrentQueueLength:function(){return this.mailbox.c;},Receive:function(G){var H,I;H=this;I=null;return B.Delay(function(){return B.Bind(H.TryReceive(G),function(J){var K,L;if(J!=null&&J.$==1)L=J.$0;else throw new C.New();return B.Return(L);});});},TryReceive:function(G){var H,I,J;function K(L){var M,N,O,P;if(z.Equals(H.mailbox.n,null)){if(I<0){H.savedCont={$:1,$0:(M=null,B.Delay(function(){L({$:1,$0:H.dequeue()});return B.Zero();}))};}else{N=[true];O=a.setTimeout(function(){if(N[0]){N[0]=false;H.savedCont=null;L(null);}},I);H.savedCont={$:1,$0:(P=null,B.Delay(function(){return N[0]?(N[0]=false,a.clearTimeout(O),L({$:1,$0:H.dequeue()}),B.Zero()):B.Zero();}))};}}else L({$:1,$0:H.dequeue()});}H=this;I=(J=this.get_DefaultTimeout(),G==null?J:G.$0);return B.FromContinuations(function(L,M,N){return K.apply(null,[L,M,N]);});},Start:function(){var G,H;G=this;this.started?D.FailWith("The MailboxProcessor has already been started."):(this.started=true,G.startAsync((H=null,B.Delay(function(){return B.TryWith(B.Delay(function(){return B.Bind(G.initial(G),function(){return B.Return(null);});}),function(I){G.errorEvent.event.Trigger(I);return B.Zero();});}))));},set_DefaultTimeout:function(G){this.DefaultTimeout=G;},get_DefaultTimeout:function(){return this.DefaultTimeout;},remove_Error:function(G){this.errorEvent.event.RemoveHandler(G);},add_Error:function(G){this.errorEvent.event.AddHandler(G);},get_Error:function(){return this.errorEvent.event;}},b.Obj,t);t.Start=function(G,H){var I;I=new t.New(G,H);I.Start();return I;};t.New=v.Ctor(function(G,H){var I,J;function K(L){return I.resume();}I=this;this.initial=G;this.token=H;this.started=false;this.errorEvent=new q.New();this.mailbox=new F.New();this.savedCont=null;J=this.token;J==null?void 0:B.Register(J.$0,function(){K();});this.DefaultTimeout=-1;},t);}());
